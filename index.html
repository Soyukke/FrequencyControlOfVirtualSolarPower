<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <!-- <link rel="stylesheet" type="text/css" href="epoch-0.8.4/tests/render/css/tests.css"> -->
        <link rel="stylesheet" type="text/css" href="./css/tests.css">
        <script src="./jquery/jquery-3.3.1.min.js"></script>
        <script src="./d3/d3.v3.js" charset="utf-8"></script>
        <script src="./epoch/js/epoch.js"></script>
        <link rel="stylesheet" type="text/css" href="./epoch/css/epoch.css">
        <script>
            var nextTime = (function() {
                var currentTime = parseInt(new Date().getTime() / 1000);
                return function() { return currentTime++; }
            })();
        </script>
   </head>

    
        <div id="test-6" class="test">
            <p id="headername">
                Frequency Control
            </p>
            <h1>SCORE: </h1>
            <div id="score" class="score">
                <p>0</p>
            </div>
        <div class="mainchart">
                <div class="epoch"></div>
            </div>
            <div class="demandchart">
                <div class="epoch"></div>
            </div>

            <p><button>Play</button></p>
        </div>

        <script>
        upper_frequency = 60.1
        lower_frequency = 59.9
        var score = $('.test .score');
        //-------グラフ描写--------------------------------------------
        $(function draw_plot(){
            var data = [
                    {label: 'upper limit', values: []},
                    {label: 'lower limit', values: []},
                    {label: 'juyou', values: []},
                    {label: 'frequency', values: []}
                ],
                length = 45,
                nextIndex = length,
                scale = 0.1,
                playing = false,
                interval = null;

            var data_demand = [
                    {label: 'juyou', values: []},
                    {label: 'frequency', values: []}
                ],
                length = 45,
                nextIndex = length,
                scale = 0.1,
                playing = false,
                interval = null;


 

            for (var i = 0; i < length; i++) {
                var x = (i+1) * scale,
                time = nextTime();
                data[0].values.push({time: time, y:upper_frequency});
                data[1].values.push({time: time, y:lower_frequency});
                data[2].values.push({time: time, y:60+0.1*Math.abs(Math.sin(time))});
                data[3].values.push({time: time, y:0.5});
            }

            // Chart 1
            var chart = $('#test-6 .mainchart .epoch').epoch({
                type: 'time.line',
                data: data,
                axes: ['right'],
                range: {right: [59.7, 60.3]},
                // format 
                tickFormats: {
                    right: function (d) {
                        return d.toFixed(2);
                    }
                }
            }) 

            // Chart 2 
            var chart_demand = $('#test-6 .demandchart .epoch').epoch({
                type: 'time.area',
                data: data_demand,
                axes: ['right', 'bottom'],
                range: {right: [59.7, 60.3]},
                tickFormats: {
                    right: function (d) {
                        return d.toFixed(2);
                    }
                }
            }) 


            var pushPoint = function() {
                var x = (nextIndex +1) * scale,
                    time = nextTime();
                chart.push([
                    { time: time, y:upper_frequency},
                    { time: time, y:lower_frequency},
                    { time: time, y:60+0.1*Math.abs(Math.sin(time))},
                    { time: time, y:60 + ($("#amount")[0].value / 100 - 0.5)}
                ]);

                chart_demand.push([
                    { time: time, y:60+0.1*Math.abs(Math.sin(time))},
                    { time: time, y:30+0.1*Math.abs(Math.cos(time))}
                ]);

                // Update score
                var new_score = String(Number(score.text()) + 1);
                score.text(new_score);
                
                nextIndex++;
            };

            $('#test-6 button').on('click', function(e) {
                if (playing) {
                    $(e.target).text('Play');
                    clearInterval(interval);
                }
                else {
                    $(e.target).text('Pause');
                    interval = setInterval(pushPoint, 1000);
                    pushPoint();
                }
                playing = !playing;
            });

        })
        </script>



        <form>
        <div class="form-group">
            <label for="amount">発電割合</label>
            <input id="amount" type="range" class="amount-control-range" min="0" max="100">
        </div>
        </form>
      </body>
  </html>